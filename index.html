<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>Live-Standort: Oberthal Stops</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    #map { height: 90vh; width: 100%; }
    #fileInput { margin: 10px; }
    .locate-button { 
      background: white; 
      border: 2px solid #666; 
      border-radius: 4px; 
      padding: 6px 10px; 
      cursor: pointer;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <input type="file" id="fileInput" accept=".csv" />
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://rawgit.com/bbecquet/Leaflet.RotatedMarker/master/leaflet.rotatedMarker.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script>
    // Karte initialisieren
    const map = L.map('map').setView([49.5, 7.0], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap-Mitwirkende'
    }).addTo(map);

    // Externes rotes Pfeil-Icon
    const arrowIcon = L.icon({
      iconUrl: 'https://img.icons8.com/ios-filled/512/gps-device.png?color=FF0000',
      iconSize: [32, 32],
      iconAnchor: [16, 16]
    });

    let userMarker = null;
    let accuracyCircle = null;
    let watchId = null;
    let tracking = true;

    function startTracking() {
      if (!navigator.geolocation) {
        alert('Geolocation nicht unterstützt.');
        return;
      }
      if (watchId !== null) return;
      watchId = navigator.geolocation.watchPosition(
        pos => {
          const { latitude, longitude, heading, accuracy } = pos.coords;
          const coords = [latitude, longitude];

          // Marker erstellen oder aktualisieren
          if (!userMarker) {
            userMarker = L.marker(coords, {
              icon: arrowIcon,
              rotationAngle: heading || 0,
              rotationOrigin: 'center center'
            }).addTo(map).bindPopup('Mein Standort');
          } else {
            userMarker.setLatLng(coords);
            if (heading !== null) userMarker.setRotationAngle(heading);
          }

          // Genauigkeitskreis
          if (!accuracyCircle) {
            accuracyCircle = L.circle(coords, { radius: accuracy }).addTo(map);
          } else {
            accuracyCircle.setLatLng(coords).setRadius(accuracy);
          }

          // Zentrieren nur wenn Tracking aktiv
          if (tracking) {
            map.setView(coords);
          }
        },
        err => console.warn('Fehler Geolocation:', err.message),
        { enableHighAccuracy: true, maximumAge: 0, timeout: 3000 }
      );
    }

    function stopTracking() {
      if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
      }
    }

    function toggleTracking() {
      tracking = !tracking;
      const btn = document.getElementById('locate-btn');
      btn.textContent = tracking ? '⏸️ Stoppen' : '▶️ Folgen';
      if (tracking) {
        startTracking();
      }
    }

    // Kontroll-Button
    const locateControl = L.control({ position: 'topright' });
    locateControl.onAdd = () => {
      const btn = L.DomUtil.create('button', 'locate-button');
      btn.id = 'locate-btn';
      btn.textContent = '⏸️ Stoppen';
      btn.title = 'Standortverfolgung ein-/ausschalten';
      L.DomEvent.on(btn, 'click', e => { L.DomEvent.stopPropagation(e); toggleTracking(); });
      return btn;
    };
    locateControl.addTo(map);

    // Tracking starten
    startTracking();

    // CSV-Import für Adressen
    async function geocode(address) {
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`;
      const res = await fetch(url, { headers: { 'User-Agent': 'OberthalMap/1.0' }});
      const data = await res.json();
      return data.length ? [parseFloat(data[0].lat), parseFloat(data[0].lon)] : null;
    }

    document.getElementById('fileInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      Papa.parse(file, {
        header: true,
        complete: async results => {
          for (const row of results.data) {
            if (!row.Straße || !row.Hausnummer || !row.Ort) continue;
            const addr = `${row.Straße} ${row.Hausnummer}, ${row.Ort}`;
            const coords = await geocode(addr);
            if (coords) L.marker(coords).addTo(map).bindPopup(addr);
          }
        }
      });
    });
  </script>
</body>
</html>
