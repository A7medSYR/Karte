<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>Live-Standort: Oberthal Stops</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    #map { height: 90vh; width: 100%; }
    #fileInput { margin: 10px; }
  </style>
</head>
<body>
  <input type="file" id="fileInput" accept=".csv" />
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script>
    // Karte initialisieren
    const map = L.map('map').setView([49.5, 7.0], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap-Mitwirkende'
    }).addTo(map);

    // Nutzer-Standort-Marker und WatchPosition einrichten
    let userMarker = null;
    if (navigator.geolocation) {
      navigator.geolocation.watchPosition(
        position => {
          const { latitude, longitude } = position.coords;
          const userCoords = [latitude, longitude];
          if (!userMarker) {
            // Erster Marker
            userMarker = L.marker(userCoords, {
              icon: L.icon({
                iconUrl: 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32]
              })
            }).addTo(map).bindPopup('Mein Standort').openPopup();
            map.setView(userCoords, 14);
          } else {
            // Position aktualisieren
            userMarker.setLatLng(userCoords);
          }
        },
        err => console.warn('Standort nicht verfügbar:', err.message),
        { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 }
      );
    } else {
      alert('Geolocation wird von deinem Browser nicht unterstützt.');
    }

    // CSV-Einträge einlesen und Marker setzen
    async function geocode(address) {
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`;
      const res = await fetch(url, { headers: { 'User-Agent': 'OberthalMap/1.0' }});
      const data = await res.json();
      return data.length ? [parseFloat(data[0].lat), parseFloat(data[0].lon)] : null;
    }

    document.getElementById('fileInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      Papa.parse(file, {
        header: true,
        complete: async function(results) {
          const rows = results.data;
          for (const row of rows) {
            if (!row.Straße || !row.Hausnummer || !row.Ort) continue;
            const addr = `${row.Straße} ${row.Hausnummer}, ${row.Ort}`;
            const coords = await geocode(addr);
            if (coords) {
              L.marker(coords).addTo(map).bindPopup(addr);
            } else {
              console.warn('Nicht gefunden:', addr);
            }
          }
        }
      });
    });
  </script>
</body>
</html>
